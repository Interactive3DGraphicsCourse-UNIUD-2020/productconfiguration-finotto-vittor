<!DOCTYPE html>
<html>
	<head>
		<title>Product Configuration Finotto - Vittor</title>
		<style>

		body {
			font-family: Arial, sans-serif;
			color: #f0f0f0;
			background-color: #6A0C0B; //#4A1919;
			margin: 0px;
			overflow: hidden;
		}

		canvas {
			width: 75%;
			height: 100%;
		}

		#gui {
			position: absolute;
			top: 2px;
			right: 25%;
		}

		#acme{
			position: absolute;
			bottom: 2px;
			left: 2px;
		}

		#stark{
			position: absolute;
			bottom: 2px;
			right: 25%;
		}

		#description{
			position: absolute;
			height: 100%;
			width: 24.5%;
			right: 2px;
			top:2px;
		}
		#button{
			position: absolute;
			right: 10%;
			bottom: 30%;
		}

	</style>
		<script src="libs/three.js"></script>
		<script src="libs/stats.min.js"></script>
    <script src="libs/dat.gui.min.js"></script>
    <script src="libs/OrbitControls.js"></script>
    <script src="libs/OBJLoader.js"></script>
    <script src="libs/GLTFLoader.js"></script>
		<script src="libs/MTLLoader.js"></script>
	</head>
	<body>
		<img src="logos/acme.png" alt="ACME logo" id="acme">
		<img src="logos/stark.png" alt="Stark logo" id="stark">
		<div id=description>
			<font size=6>
				A.C.M.E. industrustrial presents:<br>
				<b>STARK INDUSTRIES COLLABORATION</b>
			</font>
			<br><br>
			We produdly announce in our store armors and products created by Stark Industries<br>
			Here you can find some <b>IronMan helmets</b>, <b>Ironman armors</b> such as <b>Mark42</b> and <b>Hulk Buster</b> version, and even the <b>Ark Reactor</b>, <b><i>completely configurable!</i></b> <br>
			Edit your product as you wish and press the <b>ORDER NOW</b> button, later on you will receive all the other informations!
		</div>
		<button id="button" onclick="done()"> ORDER NOW! </button>
		<script>
		function done(){
			alert("Thank you for your order");
		}
		</script>

		<script>
			var shaders_materials = {};
			var shaders_names = ["Basic", "Glass", "Microfacet", "PBR", "Phong"];
			var oldObject;
			var scene = new THREE.Scene();
			var camera = new THREE.PerspectiveCamera( 75, 0.75*window.innerWidth / window.innerHeight, 0.1, 10000 );

			var renderer = new THREE.WebGLRenderer({ antialias: true });

      controls = new THREE.OrbitControls( camera, renderer.domElement );

			var spotLight = new THREE.SpotLight( 0xffffff );
			spotLight.position.set( 10, 600, 10 );

			spotLight.castShadow = true;

			spotLight.shadow.mapSize.width = 1024;
			spotLight.shadow.mapSize.height = 1024;

			spotLight.shadow.camera.near = 500;
			spotLight.shadow.camera.far = 4000;
			spotLight.shadow.camera.fov = 30;

			scene.add( spotLight );


			var spotLight1 = new THREE.SpotLight( 0xffffff );
			spotLight1.position.set( 100, 300, 100 );

			spotLight1.castShadow = true;

			spotLight1.shadow.mapSize.width = 1024;
			spotLight1.shadow.mapSize.height = 1024;

			spotLight1.shadow.camera.near = 500;
			spotLight1.shadow.camera.far = 4000;
			spotLight1.shadow.camera.fov = 30;

			scene.add( spotLight1 );



      // default: red plastic
			var product_materials = {};

      var product = {
        product: "Select Product"
			};

			var light1Parameters = {
				red: 1.0,
				green: 1.0,
				blue: 1.0,
				intensity: 1.5,
			}

			var light2Parameters = {
				red: 1.0,
				green: 1.0,
				blue: 1.0,
				intensity: 1.5,
			}


			var base_uniforms = {
				light: {
					value: [
						{
							position: spotLight.position,
							color: new THREE.Vector3(1,1,1),
							intensity: 1.5
						},
						{
							position: spotLight1.position,
							color: new THREE.Vector3(1,1,1),
							intensity: 1.5
						},
					]
				},
				roughness: {type:"f", value:0.54},
				metalness: {type:"f", value:0.27},
				reflection: {type:"f", value:0.38},
				eta: {type:"f", value:0.66},
				color: {type:"vec4", value: new THREE.Vector4()},
				map: {},
				envMap: {},
				normalMap:  {}
			}

      var box = new THREE.Box3(
        new THREE.Vector3(-50,-50,-50),
        new THREE.Vector3(50,50,50)
      );

      var sizeB = box.getSize();


			//oldObject = IronMan;


      var container = new THREE.Object3D();
      scene.add(container);
			camera.lookAt( container );
			spotLight.target=container;
			spotLight1.target=container;
      var gui;
  		var stats = new Stats();


			var loader = new THREE.CubeTextureLoader();
				loader.setPath( 'textures/Yokohama3/' );

			var textureCube = loader.load( [
					'posx.jpg', 'negx.jpg',
					'posy.jpg', 'negy.jpg',
					'posz.jpg', 'negz.jpg'
				], onLoad=env_map_loaded );

			//textureCube.onload = function(){render();};
			scene.background = textureCube;
			textureCube.minFilter = THREE.LinearMipMapLinearFilter;

			var all_materials = {};

			function env_map_loaded(){
				base_uniforms.envMap.value=textureCube;
				render();
			}

  		function init() {

  			//renderer.gammaInput = true;
  			//renderer.gammaOutput = true;
  			renderer.setClearColor( 0xf0f0f0 );

  			camera.position.set( 0, 100, 150 );
        camera.lookAt( new THREE.Vector3(0,0,0));
  			scene.add( camera );

  			document.body.appendChild( renderer.domElement );
  			renderer.setPixelRatio( window.devicePixelRatio );
  			renderer.setSize( 0.75*window.innerWidth, window.innerHeight );

  			controls.addEventListener( 'change', render );
  			controls.minDistance = 1;
  			controls.maxDistance = 10000;
  			//controls.maxPolarAngle = Math.PI / 2;
  			controls.enablePan = false;
  			controls.target.copy(new THREE.Vector3(0,0,0));
  			controls.update();

  			window.addEventListener( 'resize', onResize, false );

        stats.domElement.style.position = 'absolute';
  			stats.domElement.style.top = '0px';
  			document.body.appendChild( stats.domElement );

  		}

  		function onResize() {

  			renderer.setSize( 0.75*window.innerWidth, window.innerHeight );
  			camera.aspect = ( 0.75*window.innerWidth / window.innerHeight );
  			camera.updateProjectionMatrix();

  		}

  		function update() {
  			requestAnimationFrame( update );
  			stats.update();
  		}

  		function render() {
  			renderer.render( scene, camera );

  		}

			function updateLightUniforms(){
				/*for(var p of Object.keys(all_materials)){
					console.log(p);
						for(var m of Object.entries(all_materials[p])){
							console.log(m[1]);
							m.uniforms.light[0].intensity = light1Parameters.intensity;
							m.uniforms.light[0].color = new THREE.Vector3(
								light1Parameters.red,
								light1Parameters.green,
								light1Parameters.blu);
						m.uniforms.light[0].intensity = light2Parameters.intensity;
						m.uniforms.light[1].color = new THREE.Vector3(
								light2Parameters.red,
								light2Parameters.green,
								light2Parameters.blu);
						}*/
					for(var m of Object.entries(shaders_materials)){
						m[1].uniforms.light.value[0].intensity = light1Parameters.intensity;
						m[1].uniforms.light.value[0].color = new THREE.Vector3(
							light1Parameters.red,
							light1Parameters.green,
							light1Parameters.blue);
						m[1].uniforms.light.value[1].intensity = light2Parameters.intensity;
						m[1].uniforms.light.value[1].color = new THREE.Vector3(
							light2Parameters.red,
							light2Parameters.green,
							light2Parameters.blue);
						}
			}

  		function clearGui() {

  			if ( gui ) gui.destroy();
				gui = new dat.GUI( { autoPlace: true } );
				gui.domElement.id = 'gui';
  			gui.open();

  		}

  		function buildGui() {
  			clearGui();
        var products_list = ["IronMan", "IronMan-Helmet-1", "IronMan-Helmet-2", "Hulk-Buster-IronMan", "IronMan-Mark42", "Arc-Reactor", "Select Product"]
        gui.add(product, "product", products_list).onChange( function(newVal) {
					if(oldObject){ oldObject.visible=false;}
          for(child of container.children){
          	if(newVal=="Sphere" && child.name=="Sphere"){
							child.visible=true;
							oldObject = child;
							var product_materials = [];
          	} else if(newVal=="IronMan" && child.name=="IronMan"){
							child.visible = true;
							oldObject = child;
							var product_materials = all_materials["IronMan"];
          	} else if(newVal=="IronMan-Helmet-1" && child.name=="IronMan_Helmet_1"){
							child.visible = true;
							oldObject = child;
							var product_materials = all_materials["IronMan_Helmet_1"];
          	} else if(newVal=="IronMan-Helmet-2" && child.name=="IronMan_Helmet_2"){
							child.visible = true;
							oldObject = child;
							var product_materials = all_materials["IronMan_Helmet_2"];
          	} else if(newVal=="Hulk-Buster-IronMan" && child.name=="Hulk_Buster_IronMan"){
							child.visible = true;
							oldObject = child;
							var product_materials = all_materials["Hulk_Buster_IronMan"];
          	} else if(newVal=="IronMan-Mark42" && child.name=="IronMan_Mark42"){
							child.visible = true;
							oldObject = child;
							var product_materials = all_materials["IronMan_Mark42"];
          	} else if(newVal=="Arc-Reactor" && child.name=="Arc_Reactor"){
							child.visible = true;
							oldObject = child;
							var product_materials = all_materials["Arc_Reactor"];
          }
					render();
				}
				updateGuiMaterials(product_materials);

				render();
        });
				lights=gui.addFolder('Lights');
				var light1 = lights.addFolder("Light 1");
				light1.add(light1Parameters,'red').min(0).max(1).onChange( function(newVal) {
					updateLightUniforms();
					render();
				 });
				light1.add(light1Parameters,'green').min(0).max(1).onChange( function(newVal) {
					updateLightUniforms();
					render();
				 });
				light1.add(light1Parameters,'blue').min(0).max(1).onChange( function(newVal) {
					updateLightUniforms();
					render();
				});
				light1.add(light1Parameters,'intensity').min(0).max(10).onChange( function(newVal) {
					updateLightUniforms();
					render();
				 });
				var light2 = lights.addFolder("Light 2");
				light2.add(light2Parameters,'red').min(0).max(1).onChange( function(newVal) {
					updateLightUniforms();
					render();
				});
				light2.add(light2Parameters,'green').min(0).max(1).onChange( function(newVal) {
					updateLightUniforms();
					render();
			 });
				light2.add(light2Parameters,'blue').min(0).max(1).onChange( function(newVal) {
					updateLightUniforms();
					render();
				  });
				light2.add(light2Parameters,'intensity').min(0).max(10).onChange( function(newVal) {
					updateLightUniforms();
					render();
			 });
        materials=gui.addFolder('Materials');


  		}

			function updateGuiMaterials(productMaterials){
				//product_material = {};
				//console.log(productMaterials);
				var folder = gui.__folders["Materials"];
				folder.close();
				gui.__ul.removeChild(folder.domElement.parentNode);
				delete gui.__folders["Materials"];
				materials=gui.addFolder('Materials');
				//console.log(productMaterials);
				//var p_materials = {};
				var mats = [];
				for(var material in productMaterials){

					var p_material={
						"type": material,
						"roughness": 0.54,
						"metalness": 0.54,
						"reflection": 0.38,
						"eta": 0.66
					};

					//product_materials["material"]=material;
					//console.log(product_materials);
					var all_s = [];
					shaders_names.forEach(function (item, index, array) {
						all_s.push(item);
					});
					//all_names = shaders_names;
					all_s.push(material);
					var m = materials.addFolder("Material "+material);
					//shaders_materials[material]=material;
					m.add(p_material, "type", all_s).onChange(
						function(newVal) {
							var initialValue = this.initialValue;
							oldObject.traverse((o)=>{
									if(o.isMesh){
										if(o.material.name==initialValue){
											if(shaders_materials[newVal]){
												if(o.material.color){
													var c = new THREE.Vector4(o.material.color.r, o.material.color.g, o.material.color.b, 1.0);

												} else {
													var c = o.material.uniforms.color.value;
												}
												if(o.material.map){
													var map = o.material.map;
												}
												o.material=shaders_materials[newVal];
												o.material.uniforms.color.value=c;
												if(map){
													o.material.uniforms.map.value=map;
												}
											} else {
												o.material=all_materials[oldObject.name][newVal];
											}

											this.initialValue = o.material.name;
											console.log(o.material);
										}

									}
								});

							if(newVal=="Glass"){
								//var c = this.__gui.__controllers.length-1;
								for(var c = this.__gui.__controllers.length-1; c>=0; c--){
									if(this.__gui.__controllers[c].property!="type"){
										this.__gui.__controllers[c].remove();
									}
								}


									this.__gui.add(p_material,'reflection').min(0).max(1).onChange( function(newVal) {
									var initialValue = this.object.type;
									oldObject.traverse((o)=>{
											if(o.isMesh){
												if(o.material.name==initialValue){
													if(o.material.uniforms){
														o.material.uniforms.reflection.value=newVal;
													} else if (o.material.reflection>=0) {
														o.material.reflection = newVal;
													}
												}
											}
										});
									render()
								});

									this.__gui.add(p_material,'eta').min(0).max(1).onChange( function(newVal) {
									var type = this.object.type;
									oldObject.traverse((o)=>{
											if(o.isMesh){

												if(o.material.name==initialValue){
													if(o.material.uniforms){
														o.material.uniforms.eta.value=newVal;
														console.log(o.material.uniforms);
													} else if (o.material.eta>=0) {
														o.material.eta = newVal;
													}
												}
											}
										});
									render()
								});
							} else{
								console.log(initialValue);
							}

							render()
						});
					m.add(p_material,'roughness').min(0).max(1).onChange( function(newVal) {
						var initialValue = this.object.type;
						oldObject.traverse((o)=>{
								if(o.isMesh){
									if(o.material.name==initialValue){
										if(o.material.uniforms){
											o.material.uniforms.roughness.value=newVal;
										} else if (o.material.roughness>=0) {
											o.material.roughness = newVal;
										}
									}
								}
							});
						render()
					});
					m.add(p_material,'metalness').min(0).max(1).onChange( function(newVal) {
						var initialValue = this.object.type;
						oldObject.traverse((o)=>{
								if(o.isMesh){
									if(o.material.name==initialValue){
										if(o.material.uniforms){
											o.material.uniforms.metalness.value=newVal;
										} else if (o.material.metalness>=0) {
											o.material.metalness = newVal;
										}
									}
								}
							});
						render()
					});
				}
			}




			function load_objects(){
				objects_url = [
					["models/IronMan/IronMan.obj", "IronMan", "models/IronMan/IronMan.mtl"],
					["models/ironman_helmet/obj/helmet.obj", "IronMan_Helmet_1", "models/ironman_helmet/obj/helmet.mtl"],
					["models/30-iron-man-helmet-obj/iron_man_helmet.obj", "IronMan_Helmet_2", "models/30-iron-man-helmet-obj/iron man helmet.mtl"],
					["models/hulk_buster_iron_man/scene.gltf", "Hulk_Buster_IronMan", ""],
					["models/iron-man-mark-42/source/Iron_Man_Mark_42/Mark_42.obj", "IronMan_Mark42", "models/iron-man-mark-42/source/Iron_Man_Mark_42/Mark 42.mtl"],
					["models/Arc_Reactor/Arc_Reactor.obj", "Arc_Reactor", "models/Arc_Reactor/Arc Reactor OBJ.mtl"]
				]
				for(let url_name of objects_url){
					model_loader(url_name[0], url_name[1], url_name[2]);
				}

			}

			function model_loader(url, name, url2){
				if(url2==""){
					gltf_loader(url, name);
				} else {
					obj_loader(url, name, url2);
				}
			}


			function gltf_loader(url, name){
				// Instantiate a loader
				var loader = new THREE.GLTFLoader();
				// Load a glTF resource
				loader.load(
				// resource URL
				url,
				// called when the resource is loaded
				function ( gltf ) {
					var model = gltf.scene;
					gltf.animations; // Array<THREE.AnimationClip>
					gltf.scene; // THREE.Group
					gltf.scene.autoUpdate=false;
					gltf.scenes; // Array<THREE.Group>
					gltf.cameras; // Array<THREE.Camera>
					gltf.asset; // Object
					//spotLight.target = gltf.scene;
					model.traverse((o)=>{
						if(o.isMesh){
							//o.material.uniforms=base_uniforms;
							o.material.name="material";
							all_materials[name] = {material: o.material};
						}
					})
					var sizeO = new THREE.Box3().setFromObject(model).getSize();
          var box = new THREE.Box3(
            new THREE.Vector3(-50,-50,-50),
            new THREE.Vector3(50,50,50)
          );
          var sizeB = box.getSize();
          var ratio = sizeB.divide( sizeO );

          model.matrixAutoUpdate=false;
          var min = ratio.x;
          if(ratio.y<min) {min=ratio.y;}
          if(ratio.z<min) {min=ratio.z;}
          model.matrix.makeScale(min, min, min);
          container.add(model);
					model.visible=false;
					model.name=name;
				},
				// called while loading is progressing
				function ( gltf ) {
					console.log( ( gltf.loaded / gltf.total * 100 ) + '% loaded' );
				},
				// called when loading has errors
				function ( error ) {
					console.log( 'An error happened' +error);
				});
			}


			function obj_loader(url, name, mtl_url){
				var mtlLoader = new THREE.MTLLoader();
				mtlLoader.load( mtl_url, function( materials ) {
					materials.preload();
					all_materials[name]=materials.materials;
					var objLoader = new THREE.OBJLoader();
					objLoader.setMaterials( materials );
					objLoader.load( url, function ( object ) {
						var sizeO = new THREE.Box3().setFromObject(object).getSize();
						var box = new THREE.Box3(
							new THREE.Vector3(-50,-50,-50),
							new THREE.Vector3(50,50,50)
						);
						var sizeB = box.getSize();
						var ratio = sizeB.divide( sizeO );

						object.matrixAutoUpdate=false;
						var min = ratio.x;
						if(ratio.y<min) {min=ratio.y;}
						if(ratio.z<min) {min=ratio.z;}
						object.matrix.makeScale(min, min, min);
						container.add(object);
						object.visible=false;
						object.name=name;
					},
					// called while loading is progressing
					function ( gltf ) {
						console.log( ( gltf.loaded / gltf.total * 100 ) + '% loaded' );
					},
					// called when loading has errors
					function ( error ) {
						console.log( 'An error happened' +error);
					});
				});
			}


			function old_model_loader(url, name){
        if(url.substring(url.length - 3, url.length)=="obj"){
          var loader = new THREE.OBJLoader();
          var gltf = false;
        } else if(url.substring(url.length - 3, url.length)=="ltf"){
          var loader = new THREE.GLTFLoader();
          var gltf = true;
        }
        loader.load(url, function(object){
          if(gltf){object=object.scene;}

          var sizeO = new THREE.Box3().setFromObject(object).getSize();
          var box = new THREE.Box3(
            new THREE.Vector3(-50,-50,-50),
            new THREE.Vector3(50,50,50)
          );
          var sizeB = box.getSize();
          var ratio = sizeB.divide( sizeO );

          object.matrixAutoUpdate=false;
          var min = ratio.x;
          if(ratio.y<min) {min=ratio.y;}
          if(ratio.z<min) {min=ratio.z;}
          object.matrix.makeScale(min, min, min);
          container.add(object);
					object.visible=false;
					object.name=name;
					console.log(name+": loaded");
          //render();
        });

      }

			// This is a basic asyncronous shader loader for THREE.js.
			function shadersLoader(vertex_url, fragment_url, m_name) {
				var loader = new THREE.FileLoader();
				var material = new THREE.ShaderMaterial( {name:m_name, uniforms:base_uniforms, uniformsNeedUpdate:true});
				loader.load(vertex_url,function ( data ) {
					var vertex =  data;
					material.vertexShader = vertex;
				},);
				loader.load(fragment_url,function ( data ) {
						var fragment =  data;
						material.fragmentShader = fragment;
				},);
				shaders_materials[m_name]=material;
				//all_materials[m_name] = material;

			}

			function load_shaders(){
				for(var name of shaders_names){
					var v_url = "shaders/"+name+"Shader.vert";
					var f_url = "shaders/"+name+"Shader.frag";
					shadersLoader(v_url, f_url, name);
				}
			}

      init();
  		buildGui();
			load_objects();
			load_shaders();
  		update();
			render();
		</script>
	</body>
</html>
